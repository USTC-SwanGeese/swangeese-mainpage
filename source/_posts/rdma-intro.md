---
title: 全国大学生 RDMA 编程竞赛介绍
date: 2018-01-20 10:00:00
tags:
    - RDMA
categories:
    - Introduction
---



嗯，先贴一段比赛官网的介绍：

> 全国大学生 RDMA 编程竞赛，旨在为大学生提供学习RDMA，并成为RDMA编程高手的绝佳机会。自2013年首次举办，大赛就吸引了来自全国各地的20余家高校报名参加。在2016年举办第四届大赛时，更是吸引了70余所高校报名参加，并受到了来自国际顶尖高性能计算、云计算和大数据领域专家的广泛关注和媒体的争相报道。

简单地说呢，RDMA 是一种相对于 TCP/IP 而言完全不同的网络通信模式。TCP 通信的基础设施是**以太网卡**、**网线**、**交换机**，响应地，RDMA 通信通常需要依靠 **InfiniBand 卡**、**InfiniBand 线材**、**InfiniBand 交换机**来完成组网和通信。

InfiniBand（后面简称 IB）卡通过 PCIE 接口与计算机互联，比较特别的是，IB 卡具有**自主访问、读写内存**的能力，因此它可以完成普通的 TCP 通信完全做不到功能，即我们这里需要的 **RDMA（Remote Direct Memory Access）**。

<!--more-->

# RDMA

RDMA（Remote Direct Memory Access）技术全称远程直接数据存取，就是为了解决网络传输中服务器端数据处理的延迟而产生的。RDMA通过网络把数据直接写到对方机器的内存里，即将数据从一个系统快速移动到远程系统存储器中，而不对操作系统造成任何影响，这样就不需要用到多少计算机的处理功能。它消除了外部存储器复制和上下文切换操作，因而能解放内存带宽和CPU周期用于改进应用系统性能。

> 简单地说，利用 RDMA 技术，一个节点可以绕过 CPU，直接读写远程节点上的内存数据。

## 传统意义上的 DMA

直接内存访问（DMA）方式，是一种完全由硬件执行I/O交换的工作方式。在这种方式中， DMA 控制器从CPU 完全接管对总线的控制，数据交换不经过CPU ，而直接在内存和IO设备之间进行。DMA工作时，由DMA控制器向内存发出地址和控制信号，进行地址修改，对传送字的个数计数，并且以中断方式向CPU 报告传送操作的结束。

使用 DMA 方式的目的是减少大批量数据传输时 CPU 的开销。采用专用DMA 控制器(DMAC) 生成访存地址并控制访存过程，优点有操作均由硬件电路实现，传输速度快；CPU 基本不干预，仅在初始化和结束时参与，CPU 与外设并行工作，效率高。

---

更具体的原理就先不多说了，大家可以自己查资料看。

# 那么比赛比什么？

赛方每年会给一个原本**基于 TCP/IP** 来进行多机通信的软件，要求你**修改源代码**，把这个软件改成**基于 RDMA 的通信方式**。

17年是给了 MXNet，16年是 TensorFlow，15年是 Memcached。

每年的应用基本上都是一些行业中特别热门的软件。

那么把大象装进冰箱需要几个步骤？只要3步就够了。

1. 首先需要分析**软件源代码**，理解它的计算和多节点通信的方式；
2. 修改代码，把原来基于 TCP/IP 的 Socket 的通信拿掉，换上 RDMA；
3. 对修改的成果做测试，对比性能等等参数，写一份**英文报告**

## 代码好改吗？

是不是我找到原本用 TCP 写的例如`sendmsg`和`recvmsg`、`readv`等等这种 Socket 通信函数用 RDMA 的接口换掉就好啦？

还真不是这么简单。

---

首先，RDMA 和 TCP 的通信逻辑、整个通信过程会有根本性的区别。

TCP 通信的一般方式是（简化之后）：

- 设立 socket 通道
- 握手等等操作建立连接
- 一边 send 另一边 recv 然后数据就收到了

RDMA 的工作模式是基于一个完成队列的形式：

- 首先建立 TCP 连接
- 通过 TCP 通道交换双方的一些参数信息
- 把对方的关键参数注册到自己的 IB 卡上，这样双方的 RDMA 连接就建立完成了
- 接下来还需要创建完成队列、保护域等等一系列 RDMA 通信用的东西
- 需要被 IB 卡操作的内存区域还需要提前注册到 IB 卡上，只有这样做了，才能保证 IB 卡有读写某一块内存地址的权限，也能保证这块内存不会被操作系统换页出去
- 接收端向自己的等待队列提交一个接收请求
- 发送端向自己的等待队列提交一个发送请求，之后 IB 卡会处理这条请求，根据其中的一些信息完成访问远程服务器上内存数据的操作，完成之后向自己的完成队列提交一条完成请求的信息，这时可以通过一些 API 来查询到完成队列里面的内容
- 接收端处理完之后，也会向自己的完成队列里面提交一条完成请求的信息，这时可以通过一些 API 来查询到完成队列里面的内容

---

难点大概有这么几个：

- 要求参赛者自己理解目标软件的计算、通信模式，自己找到可以修改的源代码（赛方基本上没办法提供任何帮助）
- 把 TCP 换成 RDMA 并不是简单地换几个函数接口就好了，其中还可能涉及到通信逻辑、如何组织内存管理等等的问题
- 通信逻辑的设计可能对最终性能的影响也会比较大，例如我们基本每年成功改出来的第一个版本，光让原本的软件逻辑跑对就已经很不错了，都是没什么性能提升的，甚至可能会更慢

关于 MXNet 和 TensorFlow 有多少代码量也不需要多展开说了，基本都是几十万级别的量级。

---

> 还有一点点，过几天再补......